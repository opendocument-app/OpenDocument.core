name: tidy

on: pull_request

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: ubuntu install clang-tidy
        run: |
          sudo apt install clang-tidy-12
          clang-tidy-12 --version

      - name: set up python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - run: pip install conan

      - name: cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.ccache
            ~/.conan/data
            /Users/runner/Library/Caches/ccache
            C:/Users/runneradmin/.conan/data
          key: ${{ matrix.config.os }}-rev13
          restore-keys: |
            ${{ matrix.config.os }}-

      - name: checkout
        uses: actions/checkout@v2

      - name: conan and cmake
        run: |
          mkdir -p build
          cd build
          conan install ..
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..

      - name: clang-tidy
        run: |
          FILES=$( find . -path ./build -prune -false -o -type f \( -iname \*.cpp \) )
          clang-tidy-12 -p build -header-filter '.*' $FILES
